<link rel="import" href="../lib/polymer/polymer.html">
<link rel="import" href="../lib/paper-styles/color.html">
<link rel="import" href="../lib/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../lib/paper-input/paper-input.html">
<link rel="import" href="../lib/paper-button/paper-button.html">
<link rel="import" href="../lib/paper-card/paper-card.html">
<link rel="import" href="../lib/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../lib/paper-progress/paper-progress.html">
<link rel="import" href="../lib/paper-spinner/paper-spinner.html">
<link rel="import" href="../lib/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../lib/paper-listbox/paper-listbox.html">
<link rel="import" href="../lib/paper-item/paper-item.html">
<link rel="import" href="../lib/iron-icon/iron-icon.html">
<link rel="import" href="mdi.html">

<dom-module id="article-list">
  <template>
    <style is="custom-style">
      /** BASE **/
      :host {
        display: block;
        margin: 0;
        padding: 0;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--paper-grey-50);
        color: #fff;
        font-family: 'Roboto', 'Noto', sans-serif;
      }
      h1, h2, h3, h4, h5
      {
        font-weight: 300;
      }
      a.white
      {
        color: #fff!important;
      }

      /** TOOLBAR **/
      paper-toolbar
      {
        --paper-toolbar-background: var(--paper-purple-500);
        font-family: 'Roboto', 'Noto', sans-serif;
        z-index: 3;
      }

      /** CONTAINERS **/
      div.main
      {
        display: block;
      }
      div.main.centered
      {
        display: flex;
        text-align: left;
        justify-content: center;
        box-sizing: border-box;
        align-items: center;
        overflow: hidden;
        margin-top: -64px;
      }
      hr.bottomdivide
      {
        margin-top: 36px;
      }
      div.bottom
      {
        font-size: 11px;
        position: static;
        left: 0;
        right: 0;
        color: var(--paper-grey-500);
        display: flex;
        justify-content: center;
        box-sizing: border-box;
        align-items: flex-end;
      }
      div.bottom a
      {
        color: var(--paper-grey-900)!important;
      }

      /** SEARCH **/
      paper-input.search
      {
        margin-top: -24px;
        --paper-input-container-input: {
          font-size: 32px;
          color: var(--paper-purple-500);
          padding-bottom: 6px;
          font-weight: 500;
          opacity: 1;
          transition: opacity 1s;
        };
        --paper-input-container-color: rgba(156, 39, 176, var(--dark-secondary-opacity));
        --paper-input-container-focus-color: var(--paper-purple-500);
      }
      paper-input.search iron-icon[prefix]
      {
        width: 42px;
        height: 42px;
        position: relative;
        top: -2px;
        margin-right: 8px;
        margin-left: 6px;
        color: var(--paper-purple-500);
      }
      paper-input.search paper-spinner[prefix],
      paper-input.search paper-spinner-lite[prefix]
      {
        width: 23px;
        height: 23px;
        position: absolute;
        top: 4px;
        left: 11px;
        --paper-spinner-stroke-width: 4px;
        --paper-spinner-layer-3-color: var(--paper-purple-500);
      }
      paper-input.search paper-icon-button[suffix]
      {
        position: relative;
        top: -2px;
        color: var(--paper-purple-500);
      }
      paper-listbox#searchsuggest
      {
        display: none;
      }

      /** EVENTS **/
      paper-card.event
      {
        color: #000;
        padding: 0;
        cursor: pointer;
        transition: box-shadow 0.4s;
        margin: 1% 1%;
        width: 48%;
      }
      @media (min-width: 992px) {
        paper-card.event
        {
          width: 31%;
        }
      }
      paper-card.event:hover
      {
        box-shadow: 0 6px 10px 0 rgba(0, 0, 0, 0.14),
                  0 1px 18px 0 rgba(0, 0, 0, 0.12),
                  0 3px 5px -1px rgba(0, 0, 0, 0.4);
      }
      paper-card.event .card-image
      {
        background-position: center;
        background-size: cover;
        background-repeat: no-repeat;
        min-height: 180px;
      }
      paper-card.event .card-image .card-heading
      {
        background: -moz-linear-gradient(top, rgba(0,0,0,0) 0%, rgba(0,0,0,0.6) 60%);
        background: -webkit-linear-gradient(top, rgba(0,0,0,0) 0%,rgba(0,0,0,0.6) 100%);
        background: linear-gradient(to bottom, rgba(0,0,0,0) 0%,rgba(0,0,0,0.6) 60%);
        filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#00000000', endColorstr='#a6000000',GradientType=0 );

        top: 0px;
        height: 180px;
        color: #fff;
        font-size: 22px;
        position: relative;
        display: flex;
        justify-content: flex-end;
        box-sizing: border-box;
        align-items: flex-end;
        padding: 12px 16px;
      }
      paper-card.event .card-heading .subtitle
      {
        font-size: 12px;
        display: block;
        width: 100%;
        margin-top: 6px;
      }
      paper-card.event .card-heading .subtitle iron-icon
      {
        height: 16px;
        width: 16px;
        margin-right: 2px;
        position: relative;
        top: -1px;
      }
      paper-card.event .card-content
      {
        color: var(--paper-grey-700);
      }
      paper-card.event .card-actions
      {
        font-size: 14px;
        padding: 8px 12px;
        margin-bottom: 24px;
      }
      paper-card.event .card-actions iron-icon
      {
        width: 22px;
        height: 22px;
        position: relative;
        top: 1px;
        margin-right: 4px;
      }
      paper-card.event .card-actions .hotness
      {
        color: var(--paper-red-500);
        float: left;
      }
      paper-card.event .card-actions .hotness paper-progress
      {
        min-width: 0;
        width: 100px;
        display: inline-block;
        --paper-progress-active-color: var(--paper-red-500);
      }
      paper-card.event .card-actions .count
      {
        color: var(--paper-grey-900);
        float: right;
        position: relative;
        top: 3px;
      }
      paper-card.event .card-actions .count iron-icon
      {
        width: 20px;
        height: 20px;
        position: relative;
        top: 0px;
      }
      paper-card.event .card-actions .count iron-icon.articlecount
      {
        margin-left: 4px;
      }

    </style>

    <paper-toolbar>
      <div class="container">
        <span class="title">Project Kaleidoscope<span class="subtitle"></span>
      </div>
    </paper-toolbar>
    <div class="main">
      <div class="container">
        <br>
        <paper-input on-keydown="onSearchKeypress" id="search-main" class="search" placeholder=""><iron-icon icon="mdi:magnify" prefix></iron-icon><paper-spinner active prefix hidden></paper-spinner><paper-icon-button icon="mdi:arrow-right" suffix></paper-icon-button></paper-input>
        <br>

        <div class="row" id="events">
          <paper-card class="event col-md-4 col-xs-6">
            <div class="card-image" style="background-image: url('https://cdn.rt.com/files/2016.07/article/578fe4f4c3618869348b4567.jpg')">
              <div class="card-heading">
                <div class="card-heading-container">
                  Turkey coup: What does the state of emergency mean?
                  <br>
                  <div class="subtitle">
                    <span style='float:left'>2 days ago</span>
                    <span style='float:right'><iron-icon icon="mdi:map-marker"></iron-icon>Turkey</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="card-content">
              A state of emergency will be introduced in Turkey for three months following a coup attempt last week, President Recep Tayyip Erdogan announced on Wednesday.
            </div>
            <div class="card-actions">
              <span class="hotness"><iron-icon icon="mdi:fire"></iron-icon><paper-progress value="60"></paper-progress></span>
              <span class="count"><strong>2,038</strong> articles</span>
            </div>
          </paper-card>
          <paper-card class="event col-md-4 col-xs-6">
            <div class="card-image" style="background-image: url('https://cdn.rt.com/files/2016.07/article/578fe4f4c3618869348b4567.jpg')">
              <div class="card-heading">
                <div class="card-heading-container">
                  Turkey coup: What does the state of emergency mean?
                  <br>
                  <div class="subtitle">
                    <span style='float:left'>2 days ago</span>
                    <span style='float:right'><iron-icon icon="mdi:map-marker"></iron-icon>Turkey</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="card-content">
              A state of emergency will be introduced in Turkey for three months following a coup attempt last week, President Recep Tayyip Erdogan announced on Wednesday.
            </div>
            <div class="card-actions">
              <span class="hotness"><iron-icon icon="mdi:fire"></iron-icon><paper-progress value="60"></paper-progress></span>
              <span class="count"><strong>2,038</strong> articles</span>
            </div>
          </paper-card>
          <paper-card class="event col-md-4 col-xs-6">
            <div class="card-image" style="background-image: url('https://cdn.rt.com/files/2016.07/article/578fe4f4c3618869348b4567.jpg')">
              <div class="card-heading">
                <div class="card-heading-container">
                  Turkey coup: What does the state of emergency mean?
                  <br>
                  <div class="subtitle">
                    <span style='float:left'>2 days ago</span>
                    <span style='float:right'><iron-icon icon="mdi:map-marker"></iron-icon>Turkey</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="card-content">
              A state of emergency will be introduced in Turkey for three months following a coup attempt last week, President Recep Tayyip Erdogan announced on Wednesday.
            </div>
            <div class="card-actions">
              <span class="hotness"><iron-icon icon="mdi:fire"></iron-icon><paper-progress value="60"></paper-progress></span>
              <span class="count"><strong>2,038</strong> articles</span>
            </div>
          </paper-card>
          <paper-card class="event col-md-4 col-xs-6">
            <div class="card-image" style="background-image: url('https://cdn.rt.com/files/2016.07/article/578fe4f4c3618869348b4567.jpg')">
              <div class="card-heading">
                <div class="card-heading-container">
                  Turkey coup: What does the state of emergency mean?
                  <br>
                  <div class="subtitle">
                    <span style='float:left'>2 days ago</span>
                    <span style='float:right'><iron-icon icon="mdi:map-marker"></iron-icon>Turkey</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="card-content">
              A state of emergency will be introduced in Turkey for three months following a coup attempt last week, President Recep Tayyip Erdogan announced on Wednesday.
            </div>
            <div class="card-actions">
              <span class="hotness"><iron-icon icon="mdi:fire"></iron-icon><paper-progress value="60"></paper-progress></span>
              <span class="count"><strong>2,038</strong> articles</span>
            </div>
          </paper-card>
        </div>

      </div>
    </div>
    <hr class="bottomdivide">
    <div class="bottom">
      <div class="col-xs-4" style="text-align: left">
        <p id="image-credit"></p>
      </div>
      <div class="col-xs-4" style="text-align: center">
        <p>Website Copyright (C) Arthur Pachachura</p>
      </div>
      <div class="col-xs-4" style="text-align: right">
        <p>Article aggregation provided by <a class="white" href="https://eventregistry.org">EventRegistry</a></o>
      </div>
    </div>

  </template>

  <script src="/lib/jquery/dist/jquery.min.js"></script>
  <script src="/lib/bootstrap/dist/js/bootstrap.min.js"></script>
  <script>
    var suggestPrevValue = "";

    Polymer({
      is: 'article-list',
      ready: function() {

        /** UTILITIES (WATER, GAS, ETC.) **/
        function sleep(time) {
          return new Promise((resolve) => setTimeout(resolve, time));
        }
        function shuffle(a) {
          var j, x, i;
          for (i = a.length; i; i--) {
            j = Math.floor(Math.random() * i);
            x = a[i - 1];
            a[i - 1] = a[j];
            a[j] = x;
          }
          return a;
        }

        /** SEARCH BOX **/
        var i = 0;
        var searchSuggestTrending = [""];
        function placeholderLoop()
        {
          sleep(1000).then(() => {
            jQuery("#search-main").attr("placeholder", searchSuggestTrending[i++ % searchSuggestTrending.length]);
            jQuery('paper-input.search:not([active="true"]) input').css("opacity", 1);
            sleep(1000).then(() => {
              sleep(2000).then(() => {
                jQuery('paper-input.search:not([active="true"]) input').css("opacity", 0);
                placeholderLoop();
              });
            });
          })
        }
        $("paper-input.search input").css("opacity", 0);
        $("paper-input.search input").css("transition", "opacity 1s");

        //Get search suggestions
        window.setInterval(function(){
          if ((jQuery("paper-input.search input").val() !== suggestPrevValue) && (jQuery("paper-input.search input").val().length !== 0))
          {
            suggestPrevValue = jQuery("paper-input.search input").val();
            console.log("Getting suggestions for " + suggestPrevValue);
            var text = jQuery("paper-input.search input").val();

            //Get suggestions
            jQuery.get("http://eventregistry.org/json/suggestConcepts?prefix=" + encodeURIComponent(text) + "&lang=eng&source=concepts&source=conceptClass")
            .done(function(data) {
              data = JSON.parse(data);
              jQuery('#searchsuggest').remove();
              var html = "<paper-listbox id='searchsuggest' selected='0'>";
              for (var i=0; i<((data.length > 5) ? 5 : data.length); i++)
              {
                var icon = 'mdi:tag';
                if (data[i].type == "loc") icon = 'mdi:map-marker';
                if (data[i].type == "person") icon = 'mdi:account';
                if (data[i].type == "org") icon = 'mdi:account-multiple';

                var text = "<paper-item tabindex='" + (i+2) + "'><iron-icon icon='" + icon + "'></iron-icon>"  + data[i].label.eng + "</paper-item>";
                html += text;
              }
              if (data.length == 0)
              {
                html += "<div tabindex='-1' style='color:#666;padding:6px 12px;border:none!important'>No results found. Please try again.</div>";
              }
              html += "</paper-listbox>";
              jQuery(html).insertAfter('#search-main');
              jQuery("#searchsuggest paper-item").addClass("searchsuggest");
              jQuery("#searchsuggest").css("position","absolute");
              jQuery("#searchsuggest").css("top","134px");
              jQuery("#searchsuggest").css("padding","4px 0px");
              jQuery("#searchsuggest").css("z-index","2");
              jQuery("#searchsuggest").css("opacity","1");
              jQuery("#searchsuggest").css("min-width","420px");
              jQuery("paper-item.searchsuggest").css("margin-left", "0px");
              jQuery("paper-item.searchsuggest").css("font-size", "14px");
              jQuery("paper-item.searchsuggest").css("min-height", "0px");
              jQuery("paper-item.searchsuggest").css("height", "32px");
              jQuery("paper-item.searchsuggest iron-icon").css("margin-right", "16px");
              //Handle click
              jQuery("paper-item.searchsuggest").click(function()
              {
                jQuery('#searchsuggest').hide();
                var string = jQuery.trim(jQuery(this).text());
                suggestPrevValue = string;
                jQuery('#search-main input').val(string);
              });
              $("#search-main paper-spinner").hide();
              jQuery('#searchsuggest').show();
              jQuery("#searchsuggest paper-item.searchsuggest:nth-child(1)").select();
              jQuery("paper-item.searchsuggest:nth-child(1)").css("background-color", "#e0e0e0");
            })
            .fail(function() {
              console.warn("Failed to get concept search suggestions");
              jQuery('#searchsuggest').hide();
              $("#search-main paper-spinner").prop("hidden", true);
            });
          }
        }, 1200);

        /** IMMEDIATE API CALLS **/
        const server = "http://localhost:8001"
        //Get trending suggestions
        jQuery.get(server + "/api/1/trending/suggest")
        .done(function(data) {
          searchSuggestTrending = [ ];
          for (var j=0; j<data.list.length; j+=6)
          {
            var sublist = data.list.slice(j, j+6);
            sublist = shuffle(sublist);
            searchSuggestTrending.push(sublist[0]);
            searchSuggestTrending.push(sublist[1]);
            searchSuggestTrending.push(sublist[2]);
            searchSuggestTrending.push(sublist[3]);
            searchSuggestTrending.push(sublist[4]);
            searchSuggestTrending.push(sublist[5]);
          }
        })
        .fail(function() {
          console.warn("Failed to get trending suggestions");
        })
        .always(function() {
          placeholderLoop();
        });
      },
      onSearchKeypress: function()
      {
        //Key up
        if (event.which == 38) {
          var selected = jQuery('#searchsuggest').prop("selected");
          selected--;
          if (selected < 0) { selected = 0; }
          jQuery('#searchsuggest').prop("selected", selected);
          jQuery("paper-item.searchsuggest").css("background-color", "inherit");
          jQuery("paper-item.searchsuggest:nth-child(" + (selected + 1) + ")").css("background-color", "#e0e0e0");
          event.preventDefault();
        }
        //Key down
        else if (event.which == 40) {
          var selected = jQuery('#searchsuggest').prop("selected");
          selected++;
          var count = jQuery("#searchsuggest > paper-item").length - 1;
          if (selected > count) { selected = count; }
          jQuery("paper-item.searchsuggest").css("background-color", "inherit");
          jQuery("paper-item.searchsuggest:nth-child(" + (selected + 1) + ")").css("background-color", "#e0e0e0");
          jQuery('#searchsuggest').prop("selected", selected);
          event.preventDefault();
        }
        //Key enter
        else if (event.which == 13) {
          var suggestions = jQuery('#searchsuggest');
          if (!suggestions.is(':visible'))
          {
            if (jQuery.trim(jQuery("#search-main input").val()).length > 0)
            {
              //Search now
              console.log("Searching for " + jQuery("#search-main input").val());
            }
          }
          else
          {
            //Activate search suggestions
            jQuery('#searchsuggest paper-item:nth-child(' + (jQuery('#searchsuggest').prop("selected") + 1) + ')').click();
          }

          event.preventDefault();
        }
        //All other keys
        else if (jQuery("paper-input.search input").val() !== suggestPrevValue)
        {
          //Change blinking state
          var empty = (jQuery("paper-input.search input").val().length === 0);
          if (empty)
          {
            jQuery("paper-input.search input").css("transition", "opacity 1s");
            jQuery('#searchsuggest').hide();
          }
          else {
            $("#search-main paper-spinner").prop("hidden", false);
            $("#search-main paper-spinner").show();
            jQuery("paper-input.search input").css("transition", "none");
          }
          jQuery("paper-input.search input").css("opacity", 1);
          jQuery("paper-input.search").attr("active", !empty);
        }
      }
    });
  </script>
</dom-module>
