<!doctype html>

<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Kaleidoscope</title>

    <link rel="manifest" href="/manifest.json">
    <script src="/lib/webcomponentsjs/webcomponents-lite.js"></script>

    <link href="/lib/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="import" href="/src/app-index.html">
  </head>
  <body>
    <app-index id="app-index" style="background-size:cover;background-position:center"></app-index>

    <script src="/lib/jquery/dist/jquery.min.js"></script>
    <script src="/lib/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/trianglify/0.4.0/trianglify.min.js"></script>
    <script>

      /** PRETTY PATTERN - EXTREMELY IMPORTANT!!! **/
      // var pattern = Trianglify({
      //     width: window.innerWidth,
      //     height: window.innerHeight
      // });
      // document.body.appendChild(pattern.canvas());

      /** UTILITIES (WATER, GAS, ETC.) **/
      function sleep(time) {
        return new Promise((resolve) => setTimeout(resolve, time));
      }
      function shuffle(a) {
        var j, x, i;
        for (i = a.length; i; i--) {
          j = Math.floor(Math.random() * i);
          x = a[i - 1];
          a[i - 1] = a[j];
          a[j] = x;
        }
        return a;
      }

      /** PLACEHOLDER ANIMATION **/
      var i = 0;
      var searchSuggestTrending = [""];
      var searchSuggestGet = false;
      function placeholderLoop()
      {
        sleep(1000).then(() => {
          $("#search-main").attr("placeholder", searchSuggestTrending[i++ % searchSuggestTrending.length]);
          $('paper-input.search:not([active="true"]) input').css("opacity", 1);
          sleep(1000).then(() => {
            sleep(2000).then(() => {
              $('paper-input.search:not([active="true"]) input').css("opacity", 0);
              placeholderLoop();
            });
          });
        })
      }
      $("paper-input.search input").css("opacity", 0);
      $("paper-input.search input").css("transition", "opacity 1s");
      $("paper-input.search input").on("change paste keyup", function()
      {
        //Change blinking state
        var empty = ($("paper-input.search input").val().length === 0);
        if (empty)
        {
          $("paper-input.search input").css("transition", "opacity 1s");
          searchSuggestGet = false;
        }
        else {
          $("paper-input.search input").css("transition", "none");
          searchSuggestGet = true;
        }
        $("paper-input.search input").css("opacity", 1);
        $("paper-input.search").attr("active", !empty);
      });
      //Get search suggestions
      window.setInterval(function(){
        if (searchSuggestGet)
        {
          searchSuggestGet = false;
          var text = $("paper-input.search input").val();
          $.get("http://eventregistry.org/json/suggestConcepts?prefix=" + encodeURIComponent(text) + "&lang=eng&source=concepts&source=conceptClass")
          .done(function(data) {
            data = JSON.parse(data);
            var html = "";
            for (var i=0; i<((data.length > 5) ? 5 : data.length); i++)
            {
              var icon = 'mdi:tag';
              if (data[i].type == "loc") icon = 'mdi:map-marker';
              if (data[i].type == "person") icon = 'mdi:account';
              if (data[i].type == "org") icon = 'mdi:account-multiple';
              html += "<paper-item><iron-icon icon='" + icon + "'></iron-icon>" + data[i].label.eng + "</paper-item>";
            }
            console.log(html);
            $("#search-suggest").empty().append(html);
          })
          .fail(function() {
            console.warn("Failed to get concept search suggestions");
          });
        }
      }, 1200);


      /** IMMEDIATE API CALLS **/
      const server = "http://localhost:8001"
      //Get usage stats
      $.get(server + "/api/1/stats/string")
      .done(function(data) {
        $("#main-stat").html(data.statString);
      })
      .fail(function() {
        console.warn("Failed to get stats data");
      });
      //Get trending suggestions
      $.get(server + "/api/1/trending/suggest")
      .done(function(data) {
        console.log(data);
        searchSuggestTrending = [ ];
        for (var j=0; j<data.list.length; j+=6)
        {
          var sublist = data.list.slice(j, j+6);
          sublist = shuffle(sublist);
          searchSuggestTrending.push(sublist[0]);
          searchSuggestTrending.push(sublist[1]);
          searchSuggestTrending.push(sublist[2]);
          searchSuggestTrending.push(sublist[3]);
          searchSuggestTrending.push(sublist[4]);
          searchSuggestTrending.push(sublist[5]);
        }
      })
      .fail(function() {
        console.warn("Failed to get trending suggestions");
      })
      .always(function() {
        placeholderLoop();
      });
      //Get tranding image
      $.get(server + "/api/1/trending/images")
      .done(function(data) {
        console.log(data);
        var image = data.images[Math.floor(Math.random()*data.images.length)];
        $("#app-index").css("background-image", "url('" + image.url + "')");
        $("#image-credit").html("<strong><a style='color: rgba(255, 255, 255, 0.8)!important' href='" + image.articleUrl + "'>" + (image.caption.length > 0 ? image.caption : image.articleTitle)+ "</a></strong><br>Image credit: " + image.copyright);
      })
      .fail(function() {
        console.warn("Failed to get trending image");
      });

    </script>
  </body>
</html>
