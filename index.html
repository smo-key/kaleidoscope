<!doctype html>

<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Kaleidoscope</title>

    <link rel="manifest" href="/manifest.json">
    <script src="/lib/webcomponentsjs/webcomponents-lite.js"></script>

    <link href="/lib/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="import" href="/src/app-index.html">
  </head>
  <body>
    <app-index id="app-index" style="background-size:cover;background-position:center"></app-index>

    <script src="/lib/jquery/dist/jquery.min.js"></script>
    <script src="/lib/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/trianglify/0.4.0/trianglify.min.js"></script>
    <script>

      /** PRETTY PATTERN - EXTREMELY IMPORTANT!!! **/
      // var pattern = Trianglify({
      //     width: window.innerWidth,
      //     height: window.innerHeight
      // });
      // document.body.appendChild(pattern.canvas());

      /** UTILITIES (WATER, GAS, ETC.) **/
      function sleep(time) {
        return new Promise((resolve) => setTimeout(resolve, time));
      }
      function shuffle(array) {
        var currentIndex = array.length, temporaryValue, randomIndex;

        // While there remain elements to shuffle...
        while (0 !== currentIndex) {

          // Pick a remaining element...
          randomIndex = Math.floor(Math.random() * currentIndex);
          currentIndex -= 1;

          // And swap it with the current element.
          temporaryValue = array[currentIndex];
          array[currentIndex] = array[randomIndex];
          array[randomIndex] = temporaryValue;
        }

        return array;
      }

      /** PLACEHOLDER ANIMATION **/
      var i = 0;
      var searchSuggestTrending = [""];
      function placeholderLoop()
      {
        sleep(1000).then(() => {
          $("#search-main").attr("placeholder", searchSuggestTrending[i++ % searchSuggestTrending.length]);
          $('paper-input.search:not([active="true"]) input').css("opacity", 1);
          sleep(1000).then(() => {
            sleep(2000).then(() => {
              $('paper-input.search:not([active="true"]) input').css("opacity", 0);
              placeholderLoop();
            });
          });
        })
      }
      $("paper-input.search input").css("opacity", 0);
      $("paper-input.search input").css("transition", "opacity 1s");
      $("paper-input.search input").on("change paste keyup", function()
      {
        //Change blinking state
        var empty = ($("paper-input.search input").val().length === 0);
        if (empty)
        {
          $("paper-input.search input").css("transition", "opacity 1s");
        }
        else {
          $("paper-input.search input").css("transition", "none");
        }
        $("paper-input.search input").css("opacity", 1);
        $("paper-input.search").attr("active", !empty);
      });

      /** IMMEDIATE API CALLS **/
      const server = "http://localhost:8001"
      //Get usage stats
      $.get(server + "/api/1/stats/string")
      .done(function(data) {
        $("#main-stat").html(data.statString);
      })
      .fail(function() {
        console.warn("Failed to get stats data");
      });
      //Get tranding suggestions
      $.get(server + "/api/1/trending/suggest")
      .done(function(data) {
        searchSuggestTrending = shuffle(data.list);
      })
      .fail(function() {
        console.warn("Failed to get trending suggestions");
      })
      .always(function() {
        placeholderLoop();
      });
      //Get tranding image
      $.get(server + "/api/1/trending/images")
      .done(function(data) {
        console.log(data.images);
        var image = data.images[Math.floor(Math.random()*data.images.length)];
        console.log(image);
        $("#app-index").css("background-image", "url('" + image.url + "')");
        $("#image-credit").html("<strong><a style='color: rgba(255, 255, 255, 0.8)!important' href='" + image.articleUrl + "'>" + (image.caption.length > 0 ? image.caption : image.articleTitle)+ "</a></strong><br>Image credit: " + image.copyright);
      })
      .fail(function() {
        console.warn("Failed to get trending image");
      });

    </script>
  </body>
</html>
